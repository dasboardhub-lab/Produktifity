<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Produktivitas 2025</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>

    <!-- Recharts -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .island-loader {
            width: 18px; height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .dynamic-island-transition { transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-800 antialiased">
    <div id="root"></div>

    <!-- FIREBASE SETUP -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAqbDeVLDBRDEIfi4RliLMC-3Qrwh8p96k",
            authDomain: "logsheet-5r.firebaseapp.com",
            projectId: "logsheet-5r",
            storageBucket: "logsheet-5r.firebasestorage.app",
            messagingSenderId: "358725557740",
            appId: "1:358725557740:web:06c56d626ad32b101ff4c9"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.collection = collection;
        window.doc = doc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.writeBatch = writeBatch;
        window.appId = 'logsheet-5r-app'; 
        window.signInAnonymously = signInAnonymously;
        window.onAuthStateChanged = onAuthStateChanged;
    </script>

    <!-- REACT APP -->
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { 
            BarChart, Bar, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, 
            PieChart, Pie, Cell, ComposedChart, Area, AreaChart, ScatterChart, Scatter, ZAxis, ReferenceLine, LabelList
        } = window.Recharts || {};

        // --- ICONS ---
        const Icon = ({ path, className = "", size = 20, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {path}
            </svg>
        );

        const Icons = {
            Upload: (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></>} />,
            Filter: (props) => <Icon {...props} path={<polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>} />,
            Search: (props) => <Icon {...props} path={<><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></>} />,
            Clock: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></>} />,
            Box: (props) => <Icon {...props} path={<><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></>} />,
            Zap: (props) => <Icon {...props} path={<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>} />,
            Award: (props) => <Icon {...props} path={<><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></>} />,
            Activity: (props) => <Icon {...props} path={<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>} />,
            Database: (props) => <Icon {...props} path={<><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></>} />,
            Brain: (props) => <Icon {...props} path={<><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"></path><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"></path></>} />,
            Chart: (props) => <Icon {...props} path={<><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></>} />,
            Star: (props) => <Icon {...props} path={<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>} />,
            Trash: (props) => <Icon {...props} path={<><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></>} />,
            ArrowDown: (props) => <Icon {...props} path={<><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></>} />,
            ArrowUp: (props) => <Icon {...props} path={<><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></>} />,
            Layers: (props) => <Icon {...props} path={<><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></>} />,
            Grid: (props) => <Icon {...props} path={<><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></>} />,
            FileText: (props) => <Icon {...props} path={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></>} />,
            Briefcase: (props) => <Icon {...props} path={<><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></>} />,
            Calendar: (props) => <Icon {...props} path={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>} />,
            CheckCircle: (props) => <Icon {...props} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></>} />,
            XCircle: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></>} />,
            AlertTriangle: (props) => <Icon {...props} path={<><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></>} />,
            TrendUp: (props) => <Icon {...props} path={<><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></>} />,
            TrendDown: (props) => <Icon {...props} path={<><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></>} />,
        };

        // --- GLOBAL HELPERS ---
        const cleanNumber = (val) => {
            if (typeof val === 'number') return val;
            if (!val) return 0;
            const strVal = String(val);
            if (strVal.includes('%')) return parseFloat(strVal.replace('%', '').replace(',', '.'));
            let cleanStr = strVal.replace(/,/g, ''); 
            return parseFloat(cleanStr) || 0;
        };

        const calculateChange = (current, previous) => {
            if (!previous || previous === 0) return 0;
            return Math.round(((current - previous) / previous) * 100);
        };

        const formatOpLabel = (code) => {
            if (!code) return '';
            return code
                .replace(/\s+(in|out)$/i, '')
                .replace(/^(Prim\/sec|Console|Other)\s+/i, '')
                .replace(/\s+/g, ' ')
                .trim();
        };

        const parseDate = (dateStr) => {
            if (!dateStr) return null;
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            return new Date(`${parts[2]}-${parts[1]}-${parts[0]}`); 
        };

        const parseCSV = (text) => {
            const lines = text.split(/\r\n|\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) return [];
            
            // Auto-detect separator
            const firstLine = lines[0];
            const separator = firstLine.includes(';') ? ';' : ',';
            
            const headers = firstLine.split(separator).map(h => h.trim().replace(/^"|"$/g, ''));
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                const currentLine = lines[i];
                let values = [];
                if (separator === ',' && currentLine.includes('"')) {
                    const regex = /(?:^|,)(\"(?:[^\"]+|\"\")*\"|[^,]*)/g;
                    let match;
                    while ((match = regex.exec(currentLine))) {
                        let val = match[1];
                        if (val.length && val.charAt(0) === '"') val = val.substring(1, val.length - 1);
                        values.push(val);
                    }
                } else {
                    values = currentLine.split(separator);
                }

                if (values.length < headers.length * 0.6) continue;
                
                const obj = {};
                headers.forEach((header, index) => {
                    const val = values[index] ? values[index].trim() : '';
                    obj[header] = val;
                });
                
                if (Object.keys(obj).length > 0) result.push(obj);
            }
            return result;
        };

        // --- COMPONENTS ---
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>
                {children}
            </div>
        );

        const StatCard = ({ title, value, sub, icon: IconComp, colorClass, change, isPositive }) => (
            <div className="p-5 bg-white border border-slate-100 rounded-xl shadow-sm hover:shadow-md transition-all duration-300">
                <div className="flex justify-between items-start">
                    <div className="flex items-center gap-4">
                        <div className={`p-3 rounded-lg ${colorClass} bg-opacity-10 text-opacity-100`}>
                            <IconComp size={24} />
                        </div>
                        <div>
                            <p className="text-slate-500 text-sm font-medium tracking-wide">{title}</p>
                            <h4 className="text-2xl font-bold text-slate-800 mt-1">{value}</h4>
                            {sub && <p className="text-xs text-slate-400 mt-1">{sub}</p>}
                        </div>
                    </div>
                    {change !== undefined && change !== 0 && (
                        <div className={`flex items-center gap-1 text-xs font-semibold px-2 py-1 rounded-full ${isPositive ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'}`}>
                            {isPositive ? <Icons.TrendUp size={12} /> : <Icons.TrendDown size={12} />}
                            <span>{Math.abs(change)}%</span>
                        </div>
                    )}
                </div>
            </div>
        );

        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message, isProcessing }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm transition-opacity animate-fade-in">
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden transform transition-all scale-100 p-6">
                        <div className="text-center">
                            <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                                <Icons.AlertTriangle className="h-6 w-6 text-red-600" />
                            </div>
                            <h3 className="text-lg font-bold text-slate-900 mb-2">{title}</h3>
                            <p className="text-sm text-slate-500 mb-6 px-4">{message}</p>
                            <div className="flex gap-3 justify-center">
                                <button onClick={onClose} disabled={isProcessing} className="px-5 py-2.5 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50 transition active:scale-95">Batal</button>
                                <button onClick={onConfirm} disabled={isProcessing} className="px-5 py-2.5 rounded-xl bg-red-600 text-white font-medium hover:bg-red-700 transition shadow-lg shadow-red-200 active:scale-95 flex items-center gap-2">
                                    {isProcessing ? <div className="island-loader w-4 h-4 border-2"></div> : null}
                                    {isProcessing ? 'Menghapus...' : 'Ya, Hapus'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const DynamicIsland = ({ status, message, isVisible }) => {
            const getStyles = () => {
                switch(status) {
                    case 'loading': return "w-auto min-w-[200px] h-12 px-5 rounded-full bg-slate-900/90 backdrop-blur-md";
                    case 'success': return "w-auto min-w-[250px] h-14 px-6 rounded-full bg-emerald-600 shadow-emerald-200";
                    case 'error': return "w-auto min-w-[250px] h-14 px-6 rounded-full bg-rose-600 shadow-rose-200";
                    default: return "w-0 h-0 opacity-0 overflow-hidden";
                }
            };
            const getContent = () => {
                if (status === 'loading') return <div className="flex items-center justify-center gap-3 w-full h-full text-white"><div className="island-loader w-4 h-4"></div><span className="text-sm font-medium tracking-wide">{message || 'Memuat...'}</span></div>;
                if (status === 'success') return <div className="flex items-center justify-center gap-3 w-full h-full text-white"><Icons.CheckCircle size={20} /><span className="text-sm font-semibold">{message}</span></div>;
                if (status === 'error') return <div className="flex items-center justify-center gap-3 w-full h-full text-white"><Icons.XCircle size={20} /><span className="text-sm font-semibold">{message}</span></div>;
                return null;
            };
            return <div className={`fixed top-6 left-1/2 -translate-x-1/2 z-50 dynamic-island-transition shadow-xl flex items-center justify-center overflow-hidden ${getStyles()} ${!isVisible ? '-translate-y-24 opacity-0 scale-90' : 'translate-y-0 opacity-100 scale-100'}`}>{isVisible && getContent()}</div>;
        };

        const CATEGORIES = [
            { id: 'INBOUND', label: 'Inbound', color: 'text-blue-600 bg-blue-100', icon: Icons.ArrowDown },
            { id: 'OUTBOUND', label: 'Outbound', color: 'text-emerald-600 bg-emerald-100', icon: Icons.ArrowUp },
            { id: 'PRIM/SEC', label: 'Prim/Sec', color: 'text-violet-600 bg-violet-100', icon: Icons.Layers },
            { id: 'CONSOL', label: 'Consol', color: 'text-amber-600 bg-amber-100', icon: Icons.Grid },
            { id: 'BP', label: 'BP', color: 'text-rose-600 bg-rose-100', icon: Icons.Briefcase },
            { id: 'DOK', label: 'Dok', color: 'text-indigo-600 bg-indigo-100', icon: Icons.FileText },
            { id: 'HOURLY', label: 'Load Per Jam', color: 'text-teal-600 bg-teal-100', isSpecial: true, icon: Icons.Clock },
            { id: 'ANALYSIS', label: 'Analisa Lanjutan', color: 'text-pink-600 bg-pink-100', isSpecial: true, icon: Icons.Brain },
        ];

        // --- UPDATED OPCODE GROUPS BASED ON USER FILE ---
        const OPCODE_GROUPS = [
            { name: 'Inbound', color: 'bg-blue-50 text-blue-700 border-blue-200', codes: ['43 in', '31 in', '45 in', '619 in', '41 in', '83 in', '84 in', '207 in'] },
            { name: 'Outbound', color: 'bg-green-50 text-green-700 border-green-200', codes: ['30 out', '640 out', '82 out', '201 out', '209 out', '643 out'] },
            { name: 'Prim/Sec', color: 'bg-purple-50 text-purple-700 border-purple-200', codes: ['Prim/sec 603 Reg', 'Prim/sec  603 Big', 'Prim/sec 603 Dok', 'Prim/sec 604'] },
            { name: 'Console', color: 'bg-orange-50 text-orange-700 border-orange-200', codes: ['Console 21 Reg', 'Console 618 Reg', 'Console 21 Big', 'Console 618 Big', 'Console 21 Dok', 'Console 618 Dok'] },
            { name: 'Other', color: 'bg-gray-50 text-gray-700 border-gray-200', codes: ['Other 603', 'Other 21', 'Other 618'] }
        ];

        // --- MAIN APP ---
        function App() {
            const [data, setData] = useState([]);
            const [hourlyData, setHourlyData] = useState([]);

            const [activeTab, setActiveTab] = useState("INBOUND");
            const [filterHub, setFilterHub] = useState("All");

            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            const formatDateInput = (date) => date.toISOString().split('T')[0];
            const [startDate, setStartDate] = useState(formatDateInput(thirtyDaysAgo));
            const [endDate, setEndDate] = useState(formatDateInput(today));
            const [deleteMonth, setDeleteMonth] = useState("");
            const [showConfirmModal, setShowConfirmModal] = useState(false);
            const [searchTerm, setSearchTerm] = useState("");
            const [notifyState, setNotifyState] = useState({ status: 'idle', message: '', visible: false });
            const [user, setUser] = useState(null);
            const [isUploading, setIsUploading] = useState(false);
            const [isUploadingHourly, setIsUploadingHourly] = useState(false);
            const [isResetting, setIsResetting] = useState(false);
            const [uploadProgress, setUploadProgress] = useState(0);
            const [syncStatus, setSyncStatus] = useState("connecting");

            const showNotification = (status, message, autoHide = true) => {
                setNotifyState({ status, message, visible: true });
                if (autoHide && (status === 'success' || status === 'error')) {
                    setTimeout(() => {
                        setNotifyState(prev => ({ ...prev, visible: false }));
                        setTimeout(() => setNotifyState({ status: 'idle', message: '', visible: false }), 500);
                    }, 3000);
                }
            };

            useEffect(() => {
                const initAuth = async () => {
                    if (!window.auth) return;
                    window.onAuthStateChanged(window.auth, (u) => {
                        setUser(u);
                        if(u) setSyncStatus("idle");
                    });
                    try { await window.signInAnonymously(window.auth); } 
                    catch (err) { showNotification('error', "Gagal login DB."); }
                };
                initAuth();
            }, []);

            useEffect(() => {
                if (!user || !window.db) return;
                const colRef = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'productivity_logs');
                const unsubscribe = window.onSnapshot(colRef, (snapshot) => {
                    const loadedData = [];
                    snapshot.forEach(doc => loadedData.push({ ...doc.data(), __docId: doc.id }));
                    setData(loadedData);
                    if (loadedData.length > 0) setSyncStatus("success");
                });
                const colHourlyRef = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'hourly_logs');
                const unsubscribeHourly = window.onSnapshot(colHourlyRef, (snapshot) => {
                    const loadedHourly = [];
                    snapshot.forEach(doc => loadedHourly.push({ ...doc.data(), __docId: doc.id }));
                    loadedHourly.sort((a,b) => (a.JAM || '').localeCompare(b.JAM || ''));
                    setHourlyData(loadedHourly);
                });
                return () => { unsubscribe(); unsubscribeHourly(); };
            }, [user]);

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file || !user) return;
                setIsUploading(true);
                showNotification('loading', 'Mengupload Data...', false);
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const parsedData = parseCSV(e.target.result);
                    if (parsedData.length === 0) { 
                        showNotification('error', "File kosong."); 
                        setIsUploading(false);
                        return; 
                    }
                    const batchSize = 400; const chunks = [];
                    for (let i = 0; i < parsedData.length; i += batchSize) chunks.push(parsedData.slice(i, i + batchSize));
                    try {
                        const colRef = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'productivity_logs');
                        for (const chunk of chunks) {
                            const batch = window.writeBatch(window.db);
                            chunk.forEach(row => {
                                if (!row.TANGGAL || !row.NIK) return; 
                                const dateKey = row.TANGGAL.replace(/\//g, '-');
                                const nikKey = row.NIK || 'NONIK';
                                const jamMasukKey = Object.keys(row).find(k => k.toLowerCase().includes('masuk')) || 'Jam Masuk';
                                let jamMasuk = row[jamMasukKey] || '00:00';
                                const safeJamMasuk = String(jamMasuk).replace(/:/g, '').replace(/\s/g, '');
                                const docId = `${dateKey}_${nikKey}_${safeJamMasuk}`;
                                const docRef = window.doc(colRef, docId);
                                batch.set(docRef, row);
                            });
                            await batch.commit();
                        }
                        showNotification('success', "Data Harian Tersimpan!");
                    } catch (err) { showNotification('error', err.message); } 
                    finally { 
                        event.target.value = null; 
                        setIsUploading(false);
                    }
                };
                reader.readAsText(file);
            };

            const handleHourlyUpload = (event) => {
                const file = event.target.files[0];
                if (!file || !user) return;
                setIsUploadingHourly(true);
                showNotification('loading', 'Mengupload Load...', false);
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const parsedData = parseCSV(e.target.result);
                    if (parsedData.length === 0) { 
                        showNotification('error', "File kosong."); 
                        setIsUploadingHourly(false);
                        return; 
                    }

                    // Flexible Key Finder
                    const findKey = (row, keywords) => {
                        return Object.keys(row).find(key => 
                            keywords.some(k => key.toLowerCase().includes(k))
                        );
                    };

                    const batchSize = 400;
                    const chunks = [];
                    for (let i = 0; i < parsedData.length; i += batchSize) chunks.push(parsedData.slice(i, i + batchSize));

                    try {
                        let processed = 0;
                        const colRef = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'hourly_logs');
                        
                        let validRows = 0;
                        for (const chunk of chunks) {
                            const batch = window.writeBatch(window.db);
                            chunk.forEach(row => {
                                // MAPPING SESUAI FILE LOAD USER
                                const jamKey = findKey(row, ['jam', 'time', 'waktu']);
                                const loadKey = findKey(row, ['total parcel', 'load', 'total']);
                                const dateKey = findKey(row, ['tanggal', 'date']);
                                const nikKeyFound = findKey(row, ['nik']);
                                const hubKey = findKey(row, ['hub', 'station']);
                                const nameKey = findKey(row, ['name', 'nama']);

                                const jamRaw = row[jamKey] || row.TIME || row.JAM;
                                const loadRaw = row[loadKey] || row['Total Parcel'] || row.LOAD;
                                const tanggal = row[dateKey] || row.TANGGAL || 'GENERAL';
                                const nik = row[nikKeyFound] || row.NIK || 'GENERAL';
                                const hub = row[hubKey] || row.HUB || '';
                                const name = row[nameKey] || row.NAME || '';

                                // Parsing Time: "21.00 - 22.00" -> "21:00"
                                let jam = jamRaw;
                                if (jam && typeof jam === 'string' && jam.includes('-')) {
                                     jam = jam.split('-')[0].trim().replace('.', ':'); // "21.00" -> "21:00"
                                     if(jam.length === 4 && jam.indexOf(':') === -1) jam = jam.substring(0,2) + ":" + jam.substring(2); // "2100" -> "21:00"
                                }

                                if (jam && loadRaw !== undefined) {
                                    const safeDate = String(tanggal).replace(/\//g, '-');
                                    const safeJam = String(jam).replace(/:/g, '').replace('.', '');
                                    const safeNik = String(nik).trim();
                                    
                                    const docId = `${safeDate}_${safeNik}_${safeJam}`;
                                    const docRef = window.doc(colRef, docId);
                                    
                                    const finalLoad = cleanNumber(loadRaw);
                                    
                                    // Base Data
                                    const saveData = {
                                        JAM: jam,
                                        LOAD: finalLoad,
                                        TANGGAL: tanggal,
                                        NIK: nik,
                                        HUB: hub,
                                        NAME: name
                                    };

                                    // ADD OPCODE COLUMNS TO SAVE DATA
                                    // Iterate all headers in row and add if they match known OpCodes or just add all except system keys?
                                    // Safer to just add all keys from the row that are NOT system keys
                                    Object.keys(row).forEach(k => {
                                        if (!['TANGGAL', 'NIK', 'NAME', 'HUB', 'TIME', 'JAM', 'LOAD', 'Total Parcel', 'Idle'].includes(k)) {
                                            saveData[k] = cleanNumber(row[k]);
                                        }
                                    });

                                    batch.set(docRef, saveData);
                                    validRows++;
                                }
                            });
                            await batch.commit();
                        }

                        if (validRows === 0) {
                            showNotification('error', "Gagal membaca kolom TIME/Total Parcel.");
                        } else {
                            showNotification('success', `Berhasil! ${validRows} data tersimpan.`);
                            setActiveTab('HOURLY'); 
                        }
                    } catch (err) { 
                        console.error(err);
                        showNotification('error', "Error: " + err.message); 
                    } 
                    finally { 
                        event.target.value = null; 
                        setIsUploadingHourly(false);
                    }
                };
                reader.readAsText(file);
            };

            const handleDeleteClick = () => {
                if (!deleteMonth) { showNotification('error', "Pilih Bulan & Tahun dulu."); return; }
                setShowConfirmModal(true);
            };

            const executeDelete = async () => {
                setIsResetting(true);
                try {
                    let count = 0;
                    const BATCH_LIMIT = 450; 
                    let currentBatchCount = 0;
                    let batches = [window.writeBatch(window.db)];
                    const isTargetMonth = (dateStr) => {
                        if (!dateStr) return false;
                        const parts = dateStr.split('/');
                        if (parts.length !== 3) return false;
                        let year = parts[2];
                        let month = parts[1];
                        if (month.length === 1) month = '0' + month;
                        return `${year}-${month}` === deleteMonth;
                    };
                    data.forEach(row => {
                        if (row.TANGGAL && isTargetMonth(row.TANGGAL) && row.__docId) {
                            const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'productivity_logs', row.__docId);
                            if (currentBatchCount >= BATCH_LIMIT) { batches.push(window.writeBatch(window.db)); currentBatchCount = 0; }
                            batches[batches.length - 1].delete(docRef); currentBatchCount++; count++;
                        }
                    });
                    hourlyData.forEach(row => {
                        if (row.TANGGAL && isTargetMonth(row.TANGGAL) && row.__docId) {
                            const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'hourly_logs', row.__docId);
                            if (currentBatchCount >= BATCH_LIMIT) { batches.push(window.writeBatch(window.db)); currentBatchCount = 0; }
                            batches[batches.length - 1].delete(docRef); currentBatchCount++; count++;
                        }
                    });
                    if(count > 0) { for (const b of batches) { await b.commit(); } setShowConfirmModal(false); showNotification('success', `${count} data dihapus.`); } 
                    else { setShowConfirmModal(false); showNotification('error', `Data bulan ${deleteMonth} kosong.`); }
                } catch(e) { setShowConfirmModal(false); showNotification('error', "Gagal menghapus."); } 
                finally { setIsResetting(false); }
            };

            // --- Calculation & Filtering ---
            const uniqueHubs = useMemo(() => {
                const dailyHubs = data.map(d => d.HUB).filter(Boolean);
                const hourlyHubs = hourlyData.map(d => d.HUB).filter(Boolean);
                return [...new Set([...dailyHubs, ...hourlyHubs])].sort();
            }, [data, hourlyData]);

            const isDateInRange = (dateStr) => {
                if (!startDate && !endDate) return true;
                const d = parseDate(dateStr);
                if (!d) return false;
                const start = startDate ? new Date(startDate) : null;
                const end = endDate ? new Date(endDate) : null;
                if (start && d < start) return false;
                if (end && d > end) return false;
                return true;
            };

            const filteredData = useMemo(() => {
                return data.filter(item => {
                    const matchHub = filterHub === "All" || item.HUB === filterHub;
                    const matchDate = isDateInRange(item.TANGGAL);
                    const matchSearch = searchTerm === "" || (item.NAME && item.NAME.toLowerCase().includes(searchTerm.toLowerCase())) || (item.NIK && item.NIK.includes(searchTerm));
                    return matchHub && matchDate && matchSearch;
                });
            }, [data, filterHub, startDate, endDate, searchTerm]);

            const previousFilteredData = useMemo(() => {
                if (!startDate || !endDate) return [];
                const start = new Date(startDate);
                const end = new Date(endDate);
                const duration = end - start;
                const prevEnd = new Date(start.getTime() - 86400000); 
                const prevStart = new Date(prevEnd.getTime() - duration);
                const prevStartDateStr = prevStart.toISOString().split('T')[0];
                const prevEndDateStr = prevEnd.toISOString().split('T')[0];
                const isPrevDateInRange = (dateStr) => {
                    const d = parseDate(dateStr);
                    if (!d) return false;
                    const s = new Date(prevStartDateStr);
                    const e = new Date(prevEndDateStr);
                    return d >= s && d <= e;
                };
                return data.filter(item => {
                    const matchHub = filterHub === "All" || item.HUB === filterHub;
                    const matchDate = isPrevDateInRange(item.TANGGAL);
                    return matchHub && matchDate;
                });
            }, [data, filterHub, startDate, endDate]);

            // UPDATED FILTERING FOR HOURLY DATA (Connecting HUB & SEARCH)
            const filteredHourlyData = useMemo(() => {
                let res = hourlyData;
                
                // 1. Date Range
                if (startDate || endDate) {
                    res = res.filter(d => d.TANGGAL ? isDateInRange(d.TANGGAL) : true);
                }

                // 2. Hub Filter
                if (filterHub !== "All") {
                    res = res.filter(d => d.HUB && d.HUB === filterHub);
                }

                // 3. Search Filter (Name or NIK)
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    res = res.filter(d => 
                        (d.NAME && d.NAME.toLowerCase().includes(term)) || 
                        (d.NIK && String(d.NIK).toLowerCase().includes(term))
                    );
                }

                return res.sort((a,b) => (a.JAM || '').localeCompare(b.JAM || ''));
            }, [hourlyData, startDate, endDate, filterHub, searchTerm]);

            const getMetricTotal = (dataset, key) => dataset.reduce((acc, curr) => acc + cleanNumber(curr[key]), 0);
            const getMetricAvg = (dataset, key) => {
                if (dataset.length === 0) return 0;
                const total = dataset.reduce((acc, curr) => acc + cleanNumber(curr[key]), 0);
                return (total / dataset.length).toFixed(1);
            };

            const analysisStats = useMemo(() => {
                if (activeTab !== 'ANALYSIS' || filteredData.length === 0) return null;
                const employeeMap = {};
                filteredData.forEach(item => {
                    if (!item.NIK || !item.NAME) return;
                    if (!employeeMap[item.NIK]) employeeMap[item.NIK] = { name: item.NAME, hub: item.HUB, totalLoad: 0, totalScore: 0, totalWH: 0, count: 0 };
                    
                    let load = cleanNumber(item['LOAD TOTAL']);
                    if (load === 0) load = cleanNumber(item['LOAD INBOUND']) + cleanNumber(item['LOAD OUTBOUND']);
                    
                    let wh = cleanNumber(item['WH TOTAL']);
                    if (wh === 0) wh = cleanNumber(item['WH INBOUND']) + cleanNumber(item['WH OUTBOUND']);

                    const score = cleanNumber(item['TOTAL SCORING']) || 0;
                    
                    employeeMap[item.NIK].totalLoad += load;
                    employeeMap[item.NIK].totalWH += wh;
                    employeeMap[item.NIK].totalScore += score;
                    employeeMap[item.NIK].count += 1;
                });
                const employees = Object.values(employeeMap).map(e => {
                    const avgScore = e.count ? (e.totalScore / e.count).toFixed(1) : 0;
                    const avgLoad = e.count ? Math.round(e.totalLoad / e.count) : 0;
                    const speed = e.totalWH > 0 ? Math.round(e.totalLoad / e.totalWH) : 0;
                    return { ...e, avgScore, avgLoad, speed };
                }).filter(e => e.avgLoad > 0);
                const globalAvgLoad = employees.length ? (employees.reduce((acc, e) => acc + e.avgLoad, 0) / employees.length) : 0;
                const globalAvgScore = employees.length ? (employees.reduce((acc, e) => acc + parseFloat(e.avgScore), 0) / employees.length) : 0;
                const globalAvgSpeed = employees.length ? (employees.reduce((acc, e) => acc + e.speed, 0) / employees.length) : 0;
                const top10Sorters = [...employees].sort((a, b) => parseFloat(b.avgScore) - parseFloat(a.avgScore) || b.avgLoad - a.avgLoad).slice(0, 10).map((p) => {
                        let reason = "Solid Performer"; let type = "Standard"; let color = "bg-gray-100 text-gray-700 border-gray-200";
                        const score = parseFloat(p.avgScore); const load = p.avgLoad; const speed = p.speed;
                        if (score >= 98 && load > globalAvgLoad * 1.2) { reason = "ðŸ’Ž MVP (Perfect All-Round)"; color = "bg-purple-100 text-purple-700 border-purple-200"; }
                        else if (score >= 99) { reason = "ðŸŽ¯ Quality Master (0 Error)"; color = "bg-emerald-100 text-emerald-700 border-emerald-200"; }
                        else if (speed > globalAvgSpeed * 1.5) { reason = "âš¡ Speed Demon (Sangat Cepat)"; color = "bg-amber-100 text-amber-700 border-amber-200"; }
                        else if (load > globalAvgLoad * 1.5) { reason = "ðŸŽ Workhorse (Volume Tinggi)"; color = "bg-blue-100 text-blue-700 border-blue-200"; }
                        else if (score >= 95 && speed > globalAvgSpeed) { reason = "â­ High Quality & Fast"; color = "bg-indigo-100 text-indigo-700 border-indigo-200"; }
                        return { ...p, reason, badgeColor: color };
                    });
                const bottomPerformers = [...employees].sort((a, b) => parseFloat(a.avgScore) - parseFloat(b.avgScore)).slice(0, 5);
                return { employees, globalAvgLoad, globalAvgScore, top10Sorters, bottomPerformers };
            }, [filteredData, activeTab]);

            const currentStats = useMemo(() => {
                if (activeTab === 'ANALYSIS' || activeTab === 'HOURLY') return {}; 
                const scoringKey = activeTab === 'PRIM/SEC' ? 'SCORING PRIM/SECOND' : `SCORING ${activeTab}`;
                return {
                    wh: getMetricTotal(filteredData, `WH ${activeTab}`),
                    load: getMetricTotal(filteredData, `LOAD ${activeTab}`),
                    prdWh: getMetricAvg(filteredData, `PRD ${activeTab} BY WH`),
                    prdAttend: getMetricAvg(filteredData, `PRD ${activeTab} BY ATTENDANCE`),
                    scoring: getMetricTotal(filteredData, scoringKey) 
                };
            }, [filteredData, activeTab]);

            const previousStats = useMemo(() => {
                if (activeTab === 'ANALYSIS' || activeTab === 'HOURLY') return {};
                const scoringKey = activeTab === 'PRIM/SEC' ? 'SCORING PRIM/SECOND' : `SCORING ${activeTab}`;
                return {
                    wh: getMetricTotal(previousFilteredData, `WH ${activeTab}`),
                    load: getMetricTotal(previousFilteredData, `LOAD ${activeTab}`),
                    prdWh: getMetricAvg(previousFilteredData, `PRD ${activeTab} BY WH`),
                    prdAttend: getMetricAvg(previousFilteredData, `PRD ${activeTab} BY ATTENDANCE`),
                    scoring: getMetricTotal(previousFilteredData, scoringKey)
                };
            }, [previousFilteredData, activeTab]);

            const chartData = useMemo(() => {
                if (activeTab === 'ANALYSIS' || activeTab === 'HOURLY') return [];
                const grouped = {};
                filteredData.forEach(item => {
                    const date = item.TANGGAL;
                    if(!date) return;
                    if(!grouped[date]) grouped[date] = { date, load: 0, prd: 0, count: 0 };
                    grouped[date].load += cleanNumber(item[`LOAD ${activeTab}`]);
                    grouped[date].prd += cleanNumber(item[`PRD ${activeTab} BY WH`]);
                    grouped[date].count += 1;
                });
                return Object.values(grouped).sort((a,b) => {
                     const [da, ma, ya] = a.date.split('/');
                     const [db, mb, yb] = b.date.split('/');
                     return new Date(`${ma}/${da}/${ya}`) - new Date(`${mb}/${db}/${yb}`);
                }).map(g => ({ ...g, avgPrd: g.count ? Math.round(g.prd / g.count) : 0 }));
            }, [filteredData, activeTab]);

            const totalScoringSum = getMetricTotal(filteredData, "TOTAL SCORING");
            const prevTotalScoringSum = getMetricTotal(previousFilteredData, "TOTAL SCORING");
            const totalScoringChange = calculateChange(totalScoringSum, prevTotalScoringSum);

            const hourlyStats = useMemo(() => {
                if (activeTab !== 'HOURLY') return null;
                const dateSet = new Set(); const hourSet = new Set(); const pivotMap = {}; 
                filteredHourlyData.forEach(d => {
                    const date = d.TANGGAL || 'General'; const hour = d.JAM || '??'; const load = parseInt(d.LOAD) || 0;
                    dateSet.add(date); hourSet.add(hour);
                    if (!pivotMap[date]) pivotMap[date] = {};
                    pivotMap[date][hour] = (pivotMap[date][hour] || 0) + load;
                });
                const dates = Array.from(dateSet).sort((a, b) => { const da = parseDate(a); const db = parseDate(b); return da && db ? da - db : a.localeCompare(b); });
                const hours = Array.from(hourSet).sort();
                const chartData = hours.map(h => {
                    const totalLoad = filteredHourlyData.filter(d => d.JAM === h).reduce((acc, curr) => acc + (parseInt(curr.LOAD) || 0), 0);
                    return { JAM: h, LOAD: totalLoad };
                });
                const opCodeStats = OPCODE_GROUPS.map(group => {
                    const stats = group.codes.map(code => {
                        // AGGREGATE FROM FILTERED HOURLY DATA NOW!
                        // The individual rows in hourly data have the opcode columns
                        const total = filteredHourlyData.reduce((acc, curr) => {
                            let val = 0;
                            if (curr[code] !== undefined) val = curr[code];
                            else { const key = Object.keys(curr).find(k => k.trim().toUpperCase() === code.trim().toUpperCase()); if (key) val = curr[key]; }
                            return acc + cleanNumber(val);
                        }, 0);
                        return { code, total };
                    });
                    return { ...group, stats };
                });
                return { dates, hours, pivotMap, chartData, opCodeStats };
            }, [filteredHourlyData, activeTab]);

            if (!window.Recharts) return <div className="p-10 text-center">Loading Library...</div>;

            return (
                <div className="min-h-screen bg-slate-50 font-sans pb-20">
                    <DynamicIsland status={notifyState.status} message={notifyState.message} isVisible={notifyState.visible} />
                    <ConfirmationModal isOpen={showConfirmModal} onClose={() => setShowConfirmModal(false)} onConfirm={executeDelete} title="Hapus Data Bulan Ini" message={`Anda akan menghapus data bulan ${deleteMonth}. Aksi ini permanen.`} isProcessing={isResetting} />
                    <header className="bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-30 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
                            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl text-white shadow-lg shadow-blue-200">
                                        <Icons.Activity size={20} />
                                    </div>
                                    <div>
                                        <h1 className="text-lg font-bold text-slate-900 tracking-tight">Dashboard Produktivitas</h1>
                                        <div className="flex items-center gap-2">
                                            <span className={`w-2 h-2 rounded-full ${syncStatus === 'success' ? 'bg-emerald-500' : 'bg-amber-400'} animate-pulse`}></span>
                                            <p className="text-xs text-slate-500 font-medium">{syncStatus === 'success' ? 'Live Data' : 'Menghubungkan...'}</p>
                                        </div>
                                    </div>
                                </div>
                                <div className="flex gap-3 items-center">
                                    {(data.length > 0 || hourlyData.length > 0) && (
                                        <div className="flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-lg p-1">
                                            <input type="month" value={deleteMonth} onChange={(e) => setDeleteMonth(e.target.value)} className="bg-transparent text-xs text-slate-600 font-medium outline-none border-none px-2" />
                                            <button onClick={handleDeleteClick} className="p-1.5 bg-white text-rose-500 hover:bg-rose-50 rounded-md shadow-sm border border-slate-100 transition-colors" title="Hapus Data"><Icons.Trash size={14} /></button>
                                        </div>
                                    )}
                                    <div className="h-6 w-px bg-slate-200 mx-1"></div>
                                    <label className="flex items-center gap-2 px-3 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition cursor-pointer shadow-md shadow-slate-200 text-xs font-medium">
                                        <Icons.Upload size={14} /> <span>Produktifity</span>
                                        <input type="file" accept=".csv" className="hidden" onChange={handleFileUpload} disabled={isUploading || !user} />
                                    </label>
                                    <label className="flex items-center gap-2 px-3 py-2 bg-white text-slate-700 border border-slate-200 rounded-lg hover:bg-slate-50 transition cursor-pointer shadow-sm text-xs font-medium">
                                        <Icons.Clock size={14} /> <span>Load</span>
                                        <input type="file" accept=".csv" className="hidden" onChange={handleHourlyUpload} disabled={isUploadingHourly || !user} />
                                    </label>
                                </div>
                            </div>
                        </div>
                        {(data.length > 0 || hourlyData.length > 0) && (
                            <div className="border-t border-slate-100 bg-white/50 backdrop-blur-sm">
                                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2 flex flex-wrap gap-4 items-center justify-between">
                                    <div className="flex items-center gap-4 overflow-x-auto no-scrollbar">
                                        <div className="flex items-center gap-2 bg-slate-100/50 rounded-lg px-2 py-1.5 border border-slate-200/50">
                                            <Icons.Filter size={14} className="text-slate-400"/>
                                            <select value={filterHub} onChange={e => setFilterHub(e.target.value)} className="bg-transparent text-xs font-medium text-slate-700 outline-none cursor-pointer">
                                                <option value="All">Semua HUB</option>
                                                {uniqueHubs.map(h => <option key={h} value={h}>{h}</option>)}
                                            </select>
                                        </div>
                                        <div className="flex items-center gap-2 bg-slate-100/50 rounded-lg px-2 py-1.5 border border-slate-200/50">
                                            <Icons.Calendar size={14} className="text-slate-400"/>
                                            <input type="date" className="bg-transparent text-xs font-medium text-slate-700 outline-none" value={startDate} onChange={e => setStartDate(e.target.value)} />
                                            <span className="text-slate-300 text-xs">â†’</span>
                                            <input type="date" className="bg-transparent text-xs font-medium text-slate-700 outline-none" value={endDate} onChange={e => setEndDate(e.target.value)} />
                                        </div>
                                    </div>
                                    <div className="relative group">
                                        <Icons.Search size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors"/>
                                        <input type="text" placeholder="Cari NIK / Nama..." className="pl-9 pr-3 py-1.5 bg-slate-100/50 focus:bg-white border border-slate-200 rounded-lg text-xs w-48 focus:w-64 transition-all outline-none focus:ring-2 focus:ring-indigo-500/20" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                    </div>
                                </div>
                            </div>
                        )}
                        {(data.length > 0 || hourlyData.length > 0) && (
                            <div className="border-t border-slate-100">
                                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                                    <nav className="flex space-x-6 overflow-x-auto no-scrollbar">
                                        {CATEGORIES.map((cat) => {
                                            const isActive = activeTab === cat.id;
                                            const IconComp = cat.icon || Icons.Box;
                                            return (
                                                <button 
                                                    key={cat.id} 
                                                    onClick={() => setActiveTab(cat.id)} 
                                                    className={`
                                                        group flex items-center gap-2 py-3 text-xs font-semibold border-b-2 transition-all whitespace-nowrap
                                                        ${isActive 
                                                            ? 'border-indigo-600 text-indigo-600' 
                                                            : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'
                                                        }
                                                    `}
                                                >
                                                    <IconComp size={14} className={isActive ? 'text-indigo-600' : 'text-slate-400 group-hover:text-slate-600'} />
                                                    {cat.label}
                                                </button>
                                            );
                                        })}
                                    </nav>
                                </div>
                            </div>
                        )}
                    </header>

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-6 flex-1">
                        {data.length === 0 && hourlyData.length === 0 && !isUploading && (
                            <div className="flex flex-col items-center justify-center py-24 text-center">
                                <div className="p-6 bg-white rounded-2xl shadow-xl shadow-slate-200 mb-6 border border-slate-100 transform hover:scale-105 transition-transform duration-300">
                                    <div className="bg-indigo-50 p-4 rounded-full inline-flex text-indigo-600 mb-2">
                                        <Icons.Database size={32} />
                                    </div>
                                    <h3 className="text-lg font-bold text-slate-900 mt-4">Belum Ada Data</h3>
                                    <p className="text-slate-500 text-sm mt-2 max-w-xs">Silakan upload file CSV untuk memulai analisa produktivitas tim Anda.</p>
                                </div>
                            </div>
                        )}

                        {data.length > 0 && activeTab !== 'ANALYSIS' && activeTab !== 'HOURLY' && (
                            <div className="space-y-6 animate-fade-in">
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                    <Card className="p-6 bg-white border border-slate-100 shadow-lg shadow-slate-200/50 md:col-span-1 relative overflow-hidden group">
                                        <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110 duration-500">
                                            <Icons.Award size={100} />
                                        </div>
                                        <p className="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Total Scoring</p>
                                        <div className="flex items-end gap-3 mt-2">
                                            <h2 className="text-4xl font-extrabold text-slate-900 tracking-tight">{totalScoringSum.toLocaleString()}</h2>
                                        </div>
                                        {totalScoringChange !== 0 && (
                                            <div className={`inline-flex items-center gap-1 mt-4 px-2.5 py-1 rounded-full text-xs font-semibold ${totalScoringChange > 0 ? 'bg-emerald-50 text-emerald-700' : 'bg-rose-50 text-rose-700'}`}>
                                                {totalScoringChange > 0 ? <Icons.TrendUp size={12}/> : <Icons.TrendDown size={12}/>}
                                                <span>{Math.abs(totalScoringChange)}% vs Periode Lalu</span>
                                            </div>
                                        )}
                                    </Card>
                                    <div className="md:col-span-3 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                                        {CATEGORIES.filter(c => !c.isSpecial).map(cat => {
                                            const key = cat.id === 'PRIM/SEC' ? 'SCORING PRIM/SECOND' : `SCORING ${cat.id}`;
                                            const score = getMetricTotal(filteredData, key);
                                            const prevScore = getMetricTotal(previousFilteredData, key);
                                            const change = calculateChange(score, prevScore);
                                            const IconComp = cat.icon || Icons.Box;
                                            return (
                                                <div key={cat.id} className="bg-white border border-slate-100 rounded-xl p-4 flex flex-col justify-between hover:shadow-md transition-shadow group cursor-default">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className={`p-2 rounded-lg ${cat.color.replace('text-', 'bg-').replace('700', '100')} bg-opacity-10 ${cat.color.split(' ')[0]}`}>
                                                            <IconComp size={16} />
                                                        </div>
                                                        {change !== 0 && (
                                                            <span className={`text-[10px] font-bold ${change >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>
                                                                {change > 0 ? 'â†‘' : 'â†“'}{Math.abs(change)}%
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div>
                                                        <p className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">{cat.label}</p>
                                                        <p className="text-lg font-bold text-slate-800 mt-0.5">{score.toLocaleString()}</p>
                                                    </div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                                    <div className="lg:col-span-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                        <StatCard title={`WH ${activeTab}`} value={(currentStats.wh || 0).toLocaleString()} sub="Jam Kerja" icon={Icons.Clock} colorClass="bg-blue-600 text-white" change={calculateChange(currentStats.wh, previousStats.wh)} isPositive={calculateChange(currentStats.wh, previousStats.wh) >= 0} />
                                        <StatCard title={`LOAD ${activeTab}`} value={(currentStats.load || 0).toLocaleString()} sub="Paket" icon={Icons.Box} colorClass="bg-emerald-600 text-white" change={calculateChange(currentStats.load, previousStats.load)} isPositive={calculateChange(currentStats.load, previousStats.load) >= 0} />
                                        <StatCard title={`PRD ${activeTab} / WH`} value={currentStats.prdWh} sub="/ Jam" icon={Icons.Zap} colorClass="bg-amber-500 text-white" change={calculateChange(currentStats.prdWh, previousStats.prdWh)} isPositive={calculateChange(currentStats.prdWh, previousStats.prdWh) >= 0} />
                                        <StatCard title={`PRD ${activeTab} / ATT`} value={currentStats.prdAttend} sub="/ Orang" icon={Icons.Award} colorClass="bg-violet-600 text-white" change={calculateChange(currentStats.prdAttend, previousStats.prdAttend)} isPositive={calculateChange(currentStats.prdAttend, previousStats.prdAttend) >= 0} />
                                    </div>

                                    <Card className="lg:col-span-4 p-6 bg-white border border-slate-100 shadow-sm">
                                        <div className="flex items-center justify-between mb-8">
                                            <h3 className="font-bold text-slate-800 text-lg">Analisa Tren Harian</h3>
                                            <div className="flex gap-4 text-xs font-medium">
                                                <div className="flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-blue-500"></span> Produktivitas</div>
                                                <div className="flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-emerald-400"></span> Volume Load</div>
                                            </div>
                                        </div>
                                        <div className="h-[320px]">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <ComposedChart data={chartData}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                                    <XAxis dataKey="date" style={{fontSize: '11px', fontFamily: 'Inter'}} stroke="#94a3b8" tickLine={false} axisLine={false} dy={10} />
                                                    <YAxis yAxisId="left" orientation="left" hide={true} />
                                                    <YAxis yAxisId="right" orientation="right" hide={true} />
                                                    <Tooltip 
                                                        contentStyle={{borderRadius: '12px', border:'none', boxShadow:'0 10px 15px -3px rgb(0 0 0 / 0.1)', padding: '12px'}} 
                                                        cursor={{stroke: '#e2e8f0', strokeWidth: 1}}
                                                    />
                                                    <Bar yAxisId="right" dataKey="load" name="Volume Load" fill="#10b981" radius={[4, 4, 0, 0]} barSize={20}>
                                                        <LabelList dataKey="load" position="top" style={{ fill: '#10b981', fontSize: '10px', fontWeight: 'bold' }} />
                                                    </Bar>
                                                    <Line yAxisId="left" type="monotone" dataKey="avgPrd" name="Produktivitas" stroke="#3b82f6" strokeWidth={3} dot={{r:4, fill:'#fff', strokeWidth:2, stroke:'#3b82f6'}} activeDot={{r: 6}}>
                                                        <LabelList dataKey="avgPrd" position="top" offset={10} style={{ fill: '#3b82f6', fontSize: '10px', fontWeight: 'bold' }} />
                                                    </Line>
                                                </ComposedChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </Card>

                                    <Card className="lg:col-span-4 overflow-hidden border border-slate-100 bg-white">
                                        <div className="p-5 border-b border-slate-50 flex justify-between items-center bg-white sticky top-0 z-10">
                                            <h3 className="font-bold text-slate-800 text-sm uppercase tracking-wide">Detail Data: {activeTab}</h3>
                                            <span className="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded-md">{filteredData.length} Rows</span>
                                        </div>
                                        <div className="overflow-x-auto max-h-[500px]">
                                            <table className="w-full text-left text-xs whitespace-nowrap">
                                                <thead className="bg-slate-50 text-slate-500 font-semibold uppercase tracking-wider sticky top-0 z-10">
                                                    <tr>
                                                        <th className="px-6 py-4">Tanggal</th>
                                                        <th className="px-6 py-4">NIK</th>
                                                        <th className="px-6 py-4">Nama</th>
                                                        <th className="px-6 py-4 text-center">Score</th>
                                                        <th className="px-6 py-4 text-right">WH</th>
                                                        <th className="px-6 py-4 text-right">Load</th>
                                                        <th className="px-6 py-4 text-right">Prd/Wh</th>
                                                        <th className="px-6 py-4 text-right">Prd/Att</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-50">
                                                    {filteredData.map((row, idx) => {
                                                        const scoringKey = activeTab === 'PRIM/SEC' ? 'SCORING PRIM/SECOND' : `SCORING ${activeTab}`;
                                                        const scoreVal = parseInt(cleanNumber(row[scoringKey])) || 0;
                                                        const whVal = parseInt(cleanNumber(row[`WH ${activeTab}`])) || 0;
                                                        const loadVal = parseInt(cleanNumber(row[`LOAD ${activeTab}`])) || 0;
                                                        const prdWhVal = parseInt(cleanNumber(row[`PRD ${activeTab} BY WH`])) || 0;
                                                        const prdAttendVal = parseInt(cleanNumber(row[`PRD ${activeTab} BY ATTENDANCE`])) || 0;
                                                        
                                                        if (scoreVal === 0 && whVal === 0 && loadVal === 0 && prdWhVal === 0 && prdAttendVal === 0) return null;

                                                        return (
                                                            <tr key={idx} className="hover:bg-blue-50/50 transition-colors duration-150">
                                                                <td className="px-6 py-3 font-medium text-slate-600">{row.TANGGAL}</td>
                                                                <td className="px-6 py-3 font-mono text-slate-400">{row.NIK}</td>
                                                                <td className="px-6 py-3 font-medium text-slate-900">{row.NAME}</td>
                                                                <td className="px-6 py-3 text-center">
                                                                    <span className={`px-2 py-0.5 rounded text-[10px] font-bold ${scoreVal >= 90 ? 'bg-emerald-100 text-emerald-700' : scoreVal >= 70 ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-600'}`}>
                                                                        {scoreVal}
                                                                    </span>
                                                                </td>
                                                                <td className="px-6 py-3 text-right text-slate-600">{row[`WH ${activeTab}`] || 0}</td>
                                                                <td className="px-6 py-3 text-right font-medium text-slate-900">{loadVal.toLocaleString()}</td>
                                                                <td className="px-6 py-3 text-right font-bold text-blue-600">{prdWhVal.toLocaleString()}</td>
                                                                <td className="px-6 py-3 text-right font-bold text-indigo-600">{prdAttendVal.toLocaleString()}</td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    </Card>
                                </div>
                            </div>
                        )}

                        {activeTab === 'HOURLY' && hourlyStats ? (
                             <div className="space-y-6 animate-fade-in">
                                <Card className="p-6 bg-white border border-slate-100 shadow-sm">
                                    <div className="flex justify-between items-center mb-6">
                                        <h3 className="font-bold text-slate-800 text-lg">Distribusi Load Per Jam</h3>
                                        <span className="text-xs font-bold bg-teal-50 text-teal-700 px-3 py-1 rounded-full border border-teal-100">
                                            Total {filteredHourlyData.length} Data Points
                                        </span>
                                    </div>
                                    <div className="h-[350px]">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <ComposedChart data={hourlyStats.chartData} margin={{ top: 20, right: 0, left: 0, bottom: 0 }}>
                                                <defs>
                                                    <linearGradient id="colorLoadHourly" x1="0" y1="0" x2="0" y2="1">
                                                        <stop offset="5%" stopColor="#0d9488" stopOpacity={0.2}/>
                                                        <stop offset="95%" stopColor="#0d9488" stopOpacity={0}/>
                                                    </linearGradient>
                                                </defs>
                                                <XAxis dataKey="JAM" stroke="#94a3b8" tick={{fontSize: 10}} tickLine={false} axisLine={false} dy={10} />
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                                <Tooltip contentStyle={{borderRadius: '12px', border:'none', boxShadow:'0 4px 20px -2px rgb(0 0 0 / 0.1)'}} />
                                                <Area type="monotone" dataKey="LOAD" stroke="#0d9488" strokeWidth={3} fillOpacity={1} fill="url(#colorLoadHourly)">
                                                    <LabelList dataKey="LOAD" position="top" offset={15} style={{ fill: '#0f766e', fontSize: '11px', fontWeight: '700' }} />
                                                </Area>
                                            </ComposedChart>
                                        </ResponsiveContainer>
                                    </div>
                                </Card>

                                <Card className="overflow-hidden border border-slate-100">
                                    <div className="p-4 border-b border-slate-50 bg-white"><h3 className="font-bold text-slate-800 text-sm uppercase">Matriks Heatmap</h3></div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-center text-xs border-collapse">
                                            <thead>
                                                <tr className="bg-slate-50 text-slate-500 uppercase tracking-wider">
                                                    <th className="p-3 font-semibold text-left sticky left-0 bg-slate-50 z-10 w-32 border-b border-r border-slate-100">Tanggal</th>
                                                    {hourlyStats.hours.map(h => <th key={h} className="p-3 font-semibold border-b border-slate-100 min-w-[50px]">{h}</th>)}
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-50">
                                                {hourlyStats.dates.map(date => (
                                                    <tr key={date} className="hover:bg-slate-50/50">
                                                        <td className="p-3 text-left font-medium text-slate-700 sticky left-0 bg-white z-10 border-r border-slate-50 shadow-sm">{date}</td>
                                                        {hourlyStats.hours.map(h => {
                                                            const val = hourlyStats.pivotMap[date][h] || 0;
                                                            let bgClass = "text-slate-300";
                                                            if (val > 0) bgClass = "text-slate-600 font-medium bg-slate-50";
                                                            if (val > 500) bgClass = "text-teal-700 font-bold bg-teal-50";
                                                            if (val > 1000) bgClass = "text-emerald-700 font-bold bg-emerald-100";
                                                            
                                                            return (
                                                                <td key={`${date}-${h}`} className={`p-2 border-r border-slate-50 ${bgClass}`}>
                                                                    {val > 0 ? val.toLocaleString() : '-'}
                                                                </td>
                                                            );
                                                        })}
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </Card>

                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {hourlyStats.opCodeStats.map((group, idx) => (
                                        <Card key={idx} className="overflow-hidden border border-slate-100 hover:shadow-lg transition-shadow"> 
                                            <div className={`p-4 border-b border-slate-50 ${group.color.split(' ')[0]} bg-opacity-10`}>
                                                <h4 className="font-bold flex items-center gap-2 text-sm uppercase tracking-wide">
                                                    <Icons.Layers size={14} /> {group.name}
                                                </h4>
                                            </div>
                                            <table className="w-full text-xs">
                                                <tbody className="divide-y divide-slate-50">
                                                    {group.stats.map((stat, sIdx) => (
                                                        <tr key={sIdx} className="hover:bg-slate-50/80">
                                                            <td className="px-4 py-2.5 text-slate-500 font-medium">{formatOpLabel(stat.code)}</td>
                                                            <td className="px-4 py-2.5 text-right font-bold text-slate-800">{(stat.total || 0).toLocaleString()}</td>
                                                        </tr>
                                                    ))}
                                                    <tr className="bg-slate-50/50">
                                                        <td className="px-4 py-3 font-bold text-slate-700">Total</td>
                                                        <td className="px-4 py-3 text-right font-bold text-slate-900 border-t border-slate-200">
                                                            {(group.stats.reduce((a, b) => a + (b.total || 0), 0) || 0).toLocaleString()}
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </Card>
                                    ))}
                                </div>
                            </div>
                        ) : null}

                        {activeTab === 'ANALYSIS' && analysisStats ? (
                            <div className="space-y-6 animate-fade-in">
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <Card className="overflow-hidden border border-indigo-100 shadow-sm bg-white h-full flex flex-col">
                                        <div className="p-5 border-b border-indigo-50 bg-indigo-50/30 flex justify-between items-center">
                                            <h3 className="font-bold text-indigo-900 flex items-center gap-2"><Icons.Star size={18} className="text-amber-400" /> Top 10 Sorter (Rincian Performa)</h3>
                                            <span className="text-[10px] uppercase font-bold text-indigo-400 tracking-wider">Analisa Mendalam</span>
                                        </div>
                                        <div className="overflow-x-auto flex-1">
                                            <table className="w-full text-xs text-left">
                                                <thead className="text-slate-500 bg-slate-50 uppercase tracking-wider font-semibold border-b border-slate-100">
                                                    <tr>
                                                        <th className="px-5 py-4 w-10 text-center">#</th>
                                                        <th className="px-5 py-4">Nama</th>
                                                        <th className="px-5 py-4 text-center">Quality (Score)</th>
                                                        <th className="px-5 py-4 text-center">Volume (Load)</th>
                                                        <th className="px-5 py-4 text-center">Speed (Pcs/Jam)</th>
                                                        <th className="px-5 py-4">Keunggulan Utama</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-50">
                                                    {analysisStats.top10Sorters.map((p, idx) => (
                                                        <tr key={idx} className="hover:bg-indigo-50/30 transition-colors">
                                                            <td className="px-5 py-3 text-center font-bold text-slate-400 border-r border-slate-50 bg-slate-50/30">{idx + 1}</td>
                                                            <td className="px-5 py-3 font-bold text-slate-800 border-r border-slate-50">{p.name}</td>
                                                            <td className="px-5 py-3 text-center"><span className={`font-bold ${parseFloat(p.avgScore) >= 98 ? 'text-emerald-600' : 'text-slate-700'}`}>{p.avgScore}</span></td>
                                                            <td className="px-5 py-3 text-center"><span className="font-medium text-slate-700">{p.avgLoad.toLocaleString()}</span></td>
                                                            <td className="px-5 py-3 text-center"><span className="font-mono text-slate-600 bg-slate-100 px-2 py-0.5 rounded">{p.speed.toLocaleString()}</span></td>
                                                            <td className="px-5 py-3"><span className={`inline-flex items-center px-2.5 py-1 rounded-md text-[10px] font-bold border shadow-sm ${p.badgeColor}`}>{p.reason}</span></td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </Card>

                                    <Card className="overflow-hidden border border-rose-100 shadow-sm bg-white h-full flex flex-col">
                                        <div className="p-5 border-b border-rose-50 bg-rose-50/30 flex justify-between items-center">
                                            <h3 className="font-bold text-rose-900 flex items-center gap-2"><Icons.Activity size={18} className="text-rose-500" /> Attention Needed</h3>
                                            <span className="text-[10px] uppercase font-bold text-rose-400 tracking-wider">Perlu Coaching</span>
                                        </div>
                                        <div className="overflow-x-auto flex-1">
                                            <table className="w-full text-xs text-left">
                                                <thead className="text-slate-400 bg-slate-50 uppercase tracking-wider font-semibold">
                                                    <tr><th className="px-5 py-3">Nama</th><th className="px-5 py-3 text-right">Avg Score</th><th className="px-5 py-3 text-right">Avg Load</th><th className="px-5 py-3">Status</th></tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-50">
                                                    {analysisStats.bottomPerformers.map((p, idx) => (
                                                        <tr key={idx} className="hover:bg-rose-50/30 transition-colors">
                                                            <td className="px-5 py-3 font-medium text-slate-700">{p.name}</td>
                                                            <td className="px-5 py-3 text-right font-bold text-rose-600">{p.avgScore}</td>
                                                            <td className="px-5 py-3 text-right text-slate-500">{p.avgLoad}</td>
                                                            <td className="px-5 py-3"><span className="text-[10px] font-bold text-rose-500 bg-rose-50 px-2 py-1 rounded">Evaluasi</span></td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </Card>
                                </div>
                            </div>
                        ) : null}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>